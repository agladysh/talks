% Build with xetex.
\documentclass[aspectratio=169,handout,bigger]{beamer}

%% -------------------------------------------------------------------------- %%

\usepackage{xunicode}
\usepackage{xltxtra}
\usepackage{graphicx}

\usepackage{color}

\usepackage{setspace}
\usepackage{ragged2e}

%% -------------------------------------------------------------------------- %%

\usepackage{polyglossia}
\setmainlanguage{russian}
\setotherlanguage{english}

% NB: To get MS fonts for OS X:
%
% 1) Install MS Open XML Converter.
% 2) Install OpenXML_all_fonts.pkg from inside of Converter's mpkg.
%
% http://www.labnol.org/software/tutorials/\
% free-download-calibri-font-on-mac/3684/

\setmainfont{Calibri}
\setsansfont{Calibri}
\setmonofont{Consolas}

%% -------------------------------------------------------------------------- %%

\mode<presentation>{
  \usetheme{default}
}

\useinnertheme{circles}

\setbeamertemplate{navigation symbols}{}
\setbeamertemplate{section in toc}[sections numbered]

\definecolor{chart11}{RGB}{197, 0, 11}
\setbeamercolor{title}{fg=chart11}
\setbeamercolor{author}{fg=chart11}
\setbeamercolor{frametitle}{fg=chart11}
\setbeamercolor{itemize item}{fg=chart11}
\setbeamercolor{itemize subitem}{fg=chart11}
\setbeamercolor{itemize subsubitem}{fg=chart11}
\setbeamercolor{section in toc}{fg=chart11}

\addtobeamertemplate{frametitle}{
  \ifx\insertsubsection\empty
    \let\insertframetitle\insertsectionhead
  \else
    \let\insertframetitle\insertsubsectionhead
  \fi
}{}

\addtobeamertemplate{frametitle}{
  \ifx\insertsubsection\empty
  \else
    \let\insertframesubtitle\insertsectionhead
  \fi
}{}

\makeatletter
  \CheckCommand*\beamer@checkframetitle{%
    \@ifnextchar\bgroup\beamer@inlineframetitle{}}
  \renewcommand*\beamer@checkframetitle{%
    \global\let\beamer@frametitle\relax\@ifnextchar%
    \bgroup\beamer@inlineframetitle{}}
\makeatother

%% ========================================================================== %%

\title{Опыт работы с LuaJIT\\в нагруженных интернет-проектах}
\author{Александр ГЛАДЫШ\\CTO, LogicEditor}
\date{}

%% ========================================================================== %%

\begin{document}

\usebackgroundtemplate{
  \includegraphics[width=\paperwidth,height=\paperheight]{back_title}
}

\maketitle

%% ========================================================================== %%

\usebackgroundtemplate{
  \includegraphics[width=\paperwidth,height=\paperheight]{back}
}

\begin{frame}{Содержание}

\tableofcontents

\end{frame}

%% ========================================================================== %%

%\section{О Lua и LuaJIT}

%% -------------------------------------------------------------------------- %%

% TODO: Hack!
\section*{}
\subsection*{О Lua и LuaJIT}

\begin{frame}{}
  Lua:
  \begin{itemize}
    \item мощный,
    \item быстрый,
    \item лёгкий,
    \item расширяемый,
    \item встраиваемый
  \end{itemize}
  скриптовый язык программирования.
\end{frame}

%% -------------------------------------------------------------------------- %%

\section{О Lua и LuaJIT}
\subsection*{Кратко о языке}

\begin{frame}
  \begin{itemize}
    \item Происхождение.
    \item Рост популярности в последние годы.
    \item Где используется?
    \item LuaRocks.
  \end{itemize}
\end{frame}

%% -------------------------------------------------------------------------- %%

\subsection*{Популярные диалекты}

\begin{frame}
  \begin{itemize}
    \item Lua 5.1 vs. Lua 5.2,
    \item LuaJIT 2.0,
    \item Metalua.
  \end{itemize}
\end{frame}

%% -------------------------------------------------------------------------- %%

\subsection*{LuaJIT 2.0}

\begin{frame}
  \begin{itemize}
    \item JIT, FFI, производительность.
    \item Поддерживаемые платформы.
    \item Ограничения для x86\_64.
    \item LuaJIT vs. Lua 5.2.
    \item Следующие версии LuaJIT.
  \end{itemize}
\end{frame}

%% -------------------------------------------------------------------------- %%

\subsection*{Почему Lua?}

\begin{frame}
  Исторически: Мы вышли из игровой индустрии, где Lua "правит миром".
  \\~\\
  Прагматически:
  \begin{itemize}
    \item Работает — быстро!
    \item Писать — удобно!
    \item Освоить — легко!
  \end{itemize}
\end{frame}

%% -------------------------------------------------------------------------- %%

\subsection*{Где искать людей?}

\begin{frame}
  \begin{center}
    Переучивать.
  \end{center}
\end{frame}

%% -------------------------------------------------------------------------- %%

\subsection*{Основные проблемы при переучивании на Lua}

\begin{frame}
  \begin{itemize}
    \item Неуёмное перетачивание языка под себя:
    \begin{itemize}
      \item NIH-синдром и лёгкость доработки напильником.
      \item Цена и выгоды отхода от мэйнстрима.
    \end{itemize}
    \item Идеосинкразии языка:
    \begin{itemize}
      \item Переменные по умолчанию — глобальные.
      \item Массивы индексируются с 1.
      \item Размер массива с nil внутри — не определён.
      \item Всё, что не nil и false — истина (включая 0).
    \end{itemize}
  \end{itemize}
\end{frame}

%% -------------------------------------------------------------------------- %%

\subsection*{Самое главное!}

\begin{frame}
  \centering Когда пишете код на Lua — пишите его на Lua!
\end{frame}

%% -------------------------------------------------------------------------- %%

\subsection*{Место для Lua / LuaJIT в вашем стеке}

\begin{frame}
  В первую очередь:

  \begin{itemize}
    \item Настраиваемая пользователем логика.
    \item Код, который иначе был бы написан на C/C++/OCaml.
  \end{itemize}
\end{frame}

%% ========================================================================== %%

\section{Наш нынешний стек}

\subsection*{Фреймворки для построения веб-сервисов на Lua}

\begin{frame}
Некоторые популярные:
  \begin{itemize}
    \item Kepler/WSAPI
    \item Luvit
    \item OpenResty
  \end{itemize}

У нас — велосипед.
\end{frame}

\begin{frame}
a) Какие задачи мы решаем?
\end{frame}

\begin{frame}
b) На каком железе мы живём?
\end{frame}

\begin{frame}
c) Архитектура взаимодействия. XEN, Ubuntu (и её тюнинг), nginx (и его тюнинг), spawn-fcgi, multiwatch, LuaJIT 2, WSAPI, 0MQ, Redis (и его тюнинг). DNS-ы. Отдельностоящие сервисы. Почему так?
\end{frame}

\begin{frame}
d) Какие луашные библиотеки мы используем и почему? Годные альтернативы нашим историческим opensource-велосипедам (и какие из велосипедов — лучше альтернатив).
\end{frame}

\begin{frame}
e) Как сделано High Availability?
\end{frame}

\begin{frame}
f) Как устроен деплоймент?
\end{frame}

\begin{frame}
g) Как устроен мониторинг?
\end{frame}

\begin{frame}
h) Какие показатели по производительности? По стабильности?
\end{frame}

\begin{frame}
i) DSL для описания обработчиков запросов. Кодогенерация. Прочие рюшечки и сахар (бонус: DSL для описания SQL-данных с возможностью автогенерации продвинутого UI бэкофиса для этих данных).
\end{frame}

%% ========================================================================== %%

\section{Грабли}

\begin{frame}
a) Какие были основные проблемы? Как их решали? Несколько общих советов по отладке и оптимизации производительности при работе с Lua. Отладка отладчиком и по логам, оптимизация GC, какие параметры нужно мониторить. Профайлинг кода на LJ2. Автотесты.
\end{frame}

\begin{frame}
b) Какие проблемы не решены, и как с этим жить?
\end{frame}

\begin{frame}
i. Long polling / comet.
\end{frame}

\begin{frame}
ii. TODO
\end{frame}

%% ========================================================================== %%

\section{Каким мы видим стек следующего поколения?}

\begin{frame}
a) Ориентироваться на openresty, но не использовать его напрямую. Почему?
\end{frame}

\begin{frame}
b) Новая архитектура.
\end{frame}

\begin{frame}
i. Проще! Ещё проще!
\end{frame}

\begin{frame}
ii. Отказ от LuaRocks.
\end{frame}

\begin{frame}
iii. Полный переход на FFI.
\end{frame}

\begin{frame}
iv. Отказ от FCGI и WSAPI. Переход на epoll и библиотеку парсинга HTTP.
\end{frame}

\begin{frame}
v. Отказ от сервера конфигураций.
\end{frame}

\begin{frame}
vi Улучшенная High Availability.
\end{frame}

\begin{frame}
vii Неблокирующее API на корутинах, без коллбэков. Архитектура. Особенности реализации для основных сервисов (HTTP[S], Redis, MySQL/Postgres).
\end{frame}

\begin{frame}
viii. Новый дизайн DSL.
\end{frame}

\begin{frame}
ix. ...
\end{frame}

%% ========================================================================== %%

\section{Хотите знать больше?}

\begin{frame}
  \begin{center}
  \begin{minipage}{0.6\linewidth}
  \begin{itemize}
    \item[Official Site] lua.org, luajit.org
    \item[Wiki] lua-users.org/wiki, wiki.luajit.org
    \item[Mailing Lists] lua.org/lua-l.html, luajit.org/list.html
    \item[StackOverflow] stackoverflow.com/questions/tagged/Lua
    \item[IRC] \#lua at irc.freenode.net
  \end{itemize}
  \end{minipage}
  \end{center}
\end{frame}

%% ========================================================================== %%

\section*{Вопросы?}

\begin{frame}

\begin{center}
\Huge{ag@logiceditor.com}
\end{center}

\end{frame}

%% -------------------------------------------------------------------------- %%

\end{document}
